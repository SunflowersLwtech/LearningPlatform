<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端页面功能测试 - 所有用户角色</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .test-container {
            max-width: 1400px;
            margin: 20px auto;
            padding: 20px;
        }
        .test-result {
            margin: 3px 0;
            padding: 6px 10px;
            border-radius: 4px;
            font-size: 13px;
        }
        .test-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .test-warning {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        .test-section {
            margin: 15px 0;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            overflow: hidden;
        }
        .test-section-header {
            background-color: #f8f9fa;
            padding: 12px 15px;
            border-bottom: 1px solid #dee2e6;
            font-weight: bold;
            font-size: 14px;
        }
        .test-section-body {
            padding: 10px;
            max-height: 300px;
            overflow-y: auto;
        }
        .stats-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }
        .role-card {
            border: 2px solid #dee2e6;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .role-card.active {
            border-color: #007bff;
            box-shadow: 0 0 10px rgba(0,123,255,0.3);
        }
        .btn-test {
            margin: 3px;
            font-size: 12px;
            padding: 5px 10px;
        }
        .user-info {
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <div class="row">
            <div class="col-12">
                <h1 class="text-center mb-4">
                    <i class="fas fa-users me-2"></i>学习平台前端页面功能测试
                </h1>
                <p class="text-center text-muted">测试校长、教师、学生所有页面功能，重点关注已知问题</p>
            </div>
        </div>

        <!-- 测试统计 -->
        <div class="stats-card">
            <div class="row text-center">
                <div class="col-md-2">
                    <h4 id="totalTests">0</h4>
                    <p>总测试数</p>
                </div>
                <div class="col-md-2">
                    <h4 id="passedTests">0</h4>
                    <p>通过</p>
                </div>
                <div class="col-md-2">
                    <h4 id="failedTests">0</h4>
                    <p>失败</p>
                </div>
                <div class="col-md-2">
                    <h4 id="passRate">0%</h4>
                    <p>通过率</p>
                </div>
                <div class="col-md-2">
                    <h4 id="currentRole">未登录</h4>
                    <p>当前角色</p>
                </div>
                <div class="col-md-2">
                    <h4 id="knownIssues">0</h4>
                    <p>已知问题</p>
                </div>
            </div>
        </div>

        <!-- 测试控制 -->
        <div class="card mb-4">
            <div class="card-header">
                <h5><i class="fas fa-play me-2"></i>测试控制</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6>全面测试</h6>
                        <button class="btn btn-primary btn-test" onclick="runAllRoleTests()">
                            <i class="fas fa-play me-1"></i>测试所有角色
                        </button>
                        <button class="btn btn-warning btn-test" onclick="testKnownIssues()">
                            <i class="fas fa-exclamation-triangle me-1"></i>测试已知问题
                        </button>
                        <button class="btn btn-secondary btn-test" onclick="clearAllResults()">
                            <i class="fas fa-trash me-1"></i>清除结果
                        </button>
                    </div>
                    <div class="col-md-6">
                        <h6>单独测试</h6>
                        <button class="btn btn-success btn-test" onclick="testPrincipalPages()">
                            <i class="fas fa-crown me-1"></i>校长页面
                        </button>
                        <button class="btn btn-info btn-test" onclick="testTeacherPages()">
                            <i class="fas fa-chalkboard-teacher me-1"></i>教师页面
                        </button>
                        <button class="btn btn-primary btn-test" onclick="testStudentPages()">
                            <i class="fas fa-user-graduate me-1"></i>学生页面
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 已知问题提醒 -->
        <div class="alert alert-warning">
            <h6><i class="fas fa-exclamation-triangle me-2"></i>已知问题重点测试</h6>
            <ul class="mb-0">
                <li>用户注册功能异常，无法正常注册并且角色分配逻辑有问题</li>
                <li>校长页面：学生管理：学生搜索功能有问题</li>
                <li>权限控制边界测试</li>
                <li>前端页面跳转和显示逻辑</li>
            </ul>
        </div>

        <div class="row">
            <!-- 校长测试 -->
            <div class="col-md-4">
                <div class="role-card" id="principalCard">
                    <div class="card-header bg-warning text-dark">
                        <h6><i class="fas fa-crown me-2"></i>校长功能测试</h6>
                    </div>
                    <div class="card-body">
                        <div class="user-info" id="principalInfo">
                            <strong>测试账户:</strong> principal@school.edu<br>
                            <strong>密码:</strong> admin123<br>
                            <strong>状态:</strong> <span id="principalStatus">未登录</span>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-sign-in-alt me-2"></i>登录测试
                            </div>
                            <div class="test-section-body" id="principalLoginTests"></div>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-users me-2"></i>学生管理测试
                            </div>
                            <div class="test-section-body" id="principalStudentTests"></div>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-search me-2"></i>搜索功能测试 (已知问题)
                            </div>
                            <div class="test-section-body" id="principalSearchTests"></div>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-cogs me-2"></i>管理功能测试
                            </div>
                            <div class="test-section-body" id="principalAdminTests"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 教师测试 -->
            <div class="col-md-4">
                <div class="role-card" id="teacherCard">
                    <div class="card-header bg-info text-white">
                        <h6><i class="fas fa-chalkboard-teacher me-2"></i>教师功能测试</h6>
                    </div>
                    <div class="card-body">
                        <div class="user-info" id="teacherInfo">
                            <strong>测试账户:</strong> wang@school.edu<br>
                            <strong>密码:</strong> admin123<br>
                            <strong>状态:</strong> <span id="teacherStatus">未登录</span>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-sign-in-alt me-2"></i>登录测试
                            </div>
                            <div class="test-section-body" id="teacherLoginTests"></div>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-book me-2"></i>课程管理测试
                            </div>
                            <div class="test-section-body" id="teacherCourseTests"></div>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-tasks me-2"></i>作业管理测试
                            </div>
                            <div class="test-section-body" id="teacherAssignmentTests"></div>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-shield-alt me-2"></i>权限边界测试
                            </div>
                            <div class="test-section-body" id="teacherPermissionTests"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 学生测试 -->
            <div class="col-md-4">
                <div class="role-card" id="studentCard">
                    <div class="card-header bg-primary text-white">
                        <h6><i class="fas fa-user-graduate me-2"></i>学生功能测试</h6>
                    </div>
                    <div class="card-body">
                        <div class="user-info" id="studentInfo">
                            <strong>测试账户:</strong> 20230001<br>
                            <strong>密码:</strong> 20230001<br>
                            <strong>状态:</strong> <span id="studentStatus">未登录</span>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-sign-in-alt me-2"></i>登录测试
                            </div>
                            <div class="test-section-body" id="studentLoginTests"></div>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-tachometer-alt me-2"></i>仪表板测试
                            </div>
                            <div class="test-section-body" id="studentDashboardTests"></div>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-comments me-2"></i>讨论区测试
                            </div>
                            <div class="test-section-body" id="studentDiscussionTests"></div>
                        </div>

                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-ban me-2"></i>权限限制测试
                            </div>
                            <div class="test-section-body" id="studentRestrictionTests"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 注册功能测试 -->
        <div class="card mt-4">
            <div class="card-header bg-danger text-white">
                <h6><i class="fas fa-user-plus me-2"></i>用户注册功能测试 (已知问题)</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-user-graduate me-2"></i>学生注册测试
                            </div>
                            <div class="test-section-body" id="studentRegistrationTests"></div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="test-section">
                            <div class="test-section-header">
                                <i class="fas fa-user-tie me-2"></i>员工注册测试
                            </div>
                            <div class="test-section-body" id="staffRegistrationTests"></div>
                        </div>
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-danger btn-sm" onclick="testRegistrationIssues()">
                        <i class="fas fa-bug me-1"></i>测试注册问题
                    </button>
                    <button class="btn btn-warning btn-sm" onclick="testRoleAssignmentIssues()">
                        <i class="fas fa-user-cog me-1"></i>测试角色分配问题
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 测试统计
        const testStats = {
            total: 0,
            passed: 0,
            failed: 0,
            knownIssues: 0
        };

        // 当前用户tokens
        const userTokens = {
            principal: null,
            teacher: null,
            student: null
        };

        // API配置
        const API_BASE = '/api';

        // 工具函数
        function addTestResult(containerId, message, type = 'info', details = '') {
            testStats.total++;
            if (type === 'success') testStats.passed++;
            if (type === 'error') {
                testStats.failed++;
                if (message.includes('已知问题') || message.includes('注册') || message.includes('搜索')) {
                    testStats.knownIssues++;
                }
            }

            const container = document.getElementById(containerId);
            if (!container) return;

            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;

            const icon = type === 'success' ? 'fa-check' :
                        type === 'error' ? 'fa-times' :
                        type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info';

            resultDiv.innerHTML = `
                <i class="fas ${icon} me-1"></i>${message}
                ${details ? `<br><small>${details}</small>` : ''}
            `;

            container.appendChild(resultDiv);
            updateStats();
        }

        function updateStats() {
            document.getElementById('totalTests').textContent = testStats.total;
            document.getElementById('passedTests').textContent = testStats.passed;
            document.getElementById('failedTests').textContent = testStats.failed;
            document.getElementById('knownIssues').textContent = testStats.knownIssues;

            const passRate = testStats.total > 0 ?
                Math.round((testStats.passed / testStats.total) * 100) : 0;
            document.getElementById('passRate').textContent = passRate + '%';
        }

        function clearAllResults() {
            const containers = [
                'principalLoginTests', 'principalStudentTests', 'principalSearchTests', 'principalAdminTests',
                'teacherLoginTests', 'teacherCourseTests', 'teacherAssignmentTests', 'teacherPermissionTests',
                'studentLoginTests', 'studentDashboardTests', 'studentDiscussionTests', 'studentRestrictionTests',
                'studentRegistrationTests', 'staffRegistrationTests'
            ];

            containers.forEach(id => {
                const container = document.getElementById(id);
                if (container) container.innerHTML = '';
            });

            testStats.total = 0;
            testStats.passed = 0;
            testStats.failed = 0;
            testStats.knownIssues = 0;
            updateStats();

            // 重置状态
            document.getElementById('currentRole').textContent = '未登录';
            document.getElementById('principalStatus').textContent = '未登录';
            document.getElementById('teacherStatus').textContent = '未登录';
            document.getElementById('studentStatus').textContent = '未登录';

            // 移除活动状态
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('active');
            });
        }

        function setActiveRole(role) {
            document.querySelectorAll('.role-card').forEach(card => {
                card.classList.remove('active');
            });

            const roleNames = {
                principal: '校长',
                teacher: '教师',
                student: '学生'
            };

            document.getElementById('currentRole').textContent = roleNames[role] || '未知';
            document.getElementById(`${role}Card`).classList.add('active');
        }

        // 登录测试函数
        async function testLogin(role, credentials, containerId, statusId) {
            addTestResult(containerId, `开始${role}登录测试...`, 'info');

            try {
                const response = await fetch(`${API_BASE}/auth/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(credentials)
                });

                const data = await response.json();

                if (data.success) {
                    userTokens[role.toLowerCase()] = data.data.accessToken;
                    const user = data.data.user;

                    addTestResult(containerId, `${role}登录成功`, 'success',
                        `用户: ${user.name}, 类型: ${user.userType}, 角色: ${user.role}`);

                    document.getElementById(statusId).textContent = '已登录';
                    document.getElementById(statusId).className = 'text-success';

                    // 验证用户数据结构
                    const hasRequiredFields = user.id && user.name && user.userType;
                    addTestResult(containerId, '用户数据结构验证',
                        hasRequiredFields ? 'success' : 'error',
                        hasRequiredFields ? '包含必要字段' : '缺少必要字段');

                    // 验证Token格式
                    const tokenParts = userTokens[role.toLowerCase()].split('.');
                    addTestResult(containerId, 'Token格式验证',
                        tokenParts.length === 3 ? 'success' : 'error',
                        `Token部分数: ${tokenParts.length}`);

                    return true;
                } else {
                    addTestResult(containerId, `${role}登录失败`, 'error', data.message);
                    return false;
                }
            } catch (error) {
                addTestResult(containerId, `${role}登录错误`, 'error', error.message);
                return false;
            }
        }

        // 校长页面测试
        async function testPrincipalPages() {
            setActiveRole('principal');
            clearRoleResults('principal');

            // 登录测试
            const loginSuccess = await testLogin('校长', {
                identifier: 'principal@school.edu',
                password: 'admin123',
                userType: 'staff'
            }, 'principalLoginTests', 'principalStatus');

            if (!loginSuccess) return;

            const token = userTokens.principal;

            // 学生管理测试
            addTestResult('principalStudentTests', '开始学生管理测试...', 'info');

            try {
                const studentsResponse = await fetch(`${API_BASE}/students`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const studentsData = await studentsResponse.json();

                if (studentsData.success) {
                    addTestResult('principalStudentTests', '学生列表访问', 'success',
                        `找到${studentsData.data.length}个学生`);

                    // 测试学生详情
                    if (studentsData.data.length > 0) {
                        const studentId = studentsData.data[0]._id;
                        const detailResponse = await fetch(`${API_BASE}/students/${studentId}`, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        const detailData = await detailResponse.json();

                        addTestResult('principalStudentTests', '学生详情查看',
                            detailData.success ? 'success' : 'error',
                            detailData.success ? '可以查看学生详情' : detailData.message);
                    }
                } else {
                    addTestResult('principalStudentTests', '学生列表访问', 'error', studentsData.message);
                }
            } catch (error) {
                addTestResult('principalStudentTests', '学生管理测试', 'error', error.message);
            }

            // 搜索功能测试（已知问题）
            await testStudentSearchIssues(token);

            // 管理功能测试
            await testPrincipalAdminFunctions(token);
        }

        // 学生搜索问题测试
        async function testStudentSearchIssues(token) {
            addTestResult('principalSearchTests', '开始搜索功能测试 (已知问题)...', 'warning');

            const searchTests = [
                { name: '按姓名搜索', query: '学生', expected: true },
                { name: '按学号搜索', query: '20230001', expected: true },
                { name: '按年级搜索', query: '大一', expected: true },
                { name: '按性别搜索', query: 'male', expected: false }, // 已知问题
                { name: '空搜索', query: '', expected: true },
                { name: '不存在搜索', query: 'NOTEXIST123', expected: true }
            ];

            for (const test of searchTests) {
                try {
                    const searchUrl = `${API_BASE}/students?search=${encodeURIComponent(test.query)}`;
                    const response = await fetch(searchUrl, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const data = await response.json();

                    if (data.success) {
                        const resultCount = data.data.length;
                        const testType = test.expected ? 'success' : 'warning';
                        const message = test.expected ?
                            `${test.name} - 找到${resultCount}个结果` :
                            `${test.name} - 已知问题: 找到${resultCount}个结果`;

                        addTestResult('principalSearchTests', message, testType);

                        // 特别标记已知问题
                        if (!test.expected) {
                            addTestResult('principalSearchTests', '⚠️ 确认已知问题', 'error',
                                '按性别搜索功能存在问题，搜索结果不准确');
                        }
                    } else {
                        addTestResult('principalSearchTests', `${test.name} - 搜索失败`, 'error', data.message);
                    }
                } catch (error) {
                    addTestResult('principalSearchTests', `${test.name} - 搜索错误`, 'error', error.message);
                }
            }
        }

        // 校长管理功能测试
        async function testPrincipalAdminFunctions(token) {
            addTestResult('principalAdminTests', '开始管理功能测试...', 'info');

            const adminTests = [
                { name: '课程管理', url: '/courses' },
                { name: '班级管理', url: '/classes' },
                { name: '权限管理', url: '/permissions/permissions' },
                { name: '员工管理', url: '/staff' }
            ];

            for (const test of adminTests) {
                try {
                    const response = await fetch(`${API_BASE}${test.url}`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const data = await response.json();

                    addTestResult('principalAdminTests', test.name,
                        data.success ? 'success' : 'error',
                        data.success ? '访问正常' : data.message);
                } catch (error) {
                    addTestResult('principalAdminTests', test.name, 'error', error.message);
                }
            }
        }

        // 教师页面测试
        async function testTeacherPages() {
            setActiveRole('teacher');
            clearRoleResults('teacher');

            // 登录测试
            const loginSuccess = await testLogin('教师', {
                identifier: 'wang@school.edu',
                password: 'admin123',
                userType: 'staff'
            }, 'teacherLoginTests', 'teacherStatus');

            if (!loginSuccess) return;

            const token = userTokens.teacher;

            // 课程管理测试
            await testTeacherCourseManagement(token);

            // 作业管理测试
            await testTeacherAssignmentManagement(token);

            // 权限边界测试
            await testTeacherPermissionBoundaries(token);
        }

        // 教师课程管理测试
        async function testTeacherCourseManagement(token) {
            addTestResult('teacherCourseTests', '开始课程管理测试...', 'info');

            try {
                const response = await fetch(`${API_BASE}/courses`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    addTestResult('teacherCourseTests', '课程列表访问', 'success',
                        `可见${data.data.length}个课程`);

                    // 测试课程详情
                    if (data.data.length > 0) {
                        const courseId = data.data[0]._id;
                        const detailResponse = await fetch(`${API_BASE}/courses/${courseId}`, {
                            headers: { Authorization: `Bearer ${token}` }
                        });
                        const detailData = await detailResponse.json();

                        addTestResult('teacherCourseTests', '课程详情查看',
                            detailData.success ? 'success' : 'error');
                    }
                } else {
                    addTestResult('teacherCourseTests', '课程列表访问', 'error', data.message);
                }
            } catch (error) {
                addTestResult('teacherCourseTests', '课程管理测试', 'error', error.message);
            }
        }

        // 教师作业管理测试
        async function testTeacherAssignmentManagement(token) {
            addTestResult('teacherAssignmentTests', '开始作业管理测试...', 'info');

            try {
                const response = await fetch(`${API_BASE}/assignments`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    addTestResult('teacherAssignmentTests', '作业列表访问', 'success',
                        `找到${data.data.length}个作业`);
                } else {
                    addTestResult('teacherAssignmentTests', '作业列表访问', 'error', data.message);
                }
            } catch (error) {
                addTestResult('teacherAssignmentTests', '作业管理测试', 'error', error.message);
            }
        }

        // 教师权限边界测试
        async function testTeacherPermissionBoundaries(token) {
            addTestResult('teacherPermissionTests', '开始权限边界测试...', 'info');

            // 测试不应该访问的功能
            const restrictedTests = [
                { name: '权限管理', url: '/permissions/permissions', shouldFail: true },
                { name: '系统设置', url: '/settings', shouldFail: true },
                { name: '学生列表', url: '/students', shouldFail: false } // 教师应该能访问
            ];

            for (const test of restrictedTests) {
                try {
                    const response = await fetch(`${API_BASE}${test.url}`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });

                    const success = response.status === 200;
                    const testPassed = test.shouldFail ? !success : success;

                    addTestResult('teacherPermissionTests', test.name,
                        testPassed ? 'success' : 'error',
                        test.shouldFail ?
                            (success ? '应该被拒绝但没有' : '正确被拒绝') :
                            (success ? '正确允许访问' : '应该允许但被拒绝'));
                } catch (error) {
                    addTestResult('teacherPermissionTests', test.name,
                        test.shouldFail ? 'success' : 'error',
                        test.shouldFail ? '正确被拒绝' : error.message);
                }
            }
        }

        function clearRoleResults(role) {
            const containers = {
                principal: ['principalLoginTests', 'principalStudentTests', 'principalSearchTests', 'principalAdminTests'],
                teacher: ['teacherLoginTests', 'teacherCourseTests', 'teacherAssignmentTests', 'teacherPermissionTests'],
                student: ['studentLoginTests', 'studentDashboardTests', 'studentDiscussionTests', 'studentRestrictionTests']
            };

            if (containers[role]) {
                containers[role].forEach(id => {
                    const container = document.getElementById(id);
                    if (container) container.innerHTML = '';
                });
            }
        }

        // 学生页面测试
        async function testStudentPages() {
            setActiveRole('student');
            clearRoleResults('student');

            // 登录测试
            const loginSuccess = await testLogin('学生', {
                identifier: '20230001',
                password: '20230001',
                userType: 'student'
            }, 'studentLoginTests', 'studentStatus');

            if (!loginSuccess) return;

            const token = userTokens.student;

            // 仪表板测试
            await testStudentDashboard(token);

            // 讨论区测试
            await testStudentDiscussion(token);

            // 权限限制测试
            await testStudentRestrictions(token);
        }

        // 学生仪表板测试
        async function testStudentDashboard(token) {
            addTestResult('studentDashboardTests', '开始仪表板测试...', 'info');

            try {
                const response = await fetch(`${API_BASE}/learning/dashboard`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    const dashboardData = data.data;
                    addTestResult('studentDashboardTests', '仪表板访问', 'success',
                        `待完成作业: ${dashboardData.pendingAssignments.length}, 最近提交: ${dashboardData.recentSubmissions.length}`);

                    // 验证数据结构
                    const hasRequiredFields = dashboardData.hasOwnProperty('pendingAssignments') &&
                                            dashboardData.hasOwnProperty('recentSubmissions') &&
                                            dashboardData.hasOwnProperty('activeDiscussions');

                    addTestResult('studentDashboardTests', '数据结构验证',
                        hasRequiredFields ? 'success' : 'error',
                        hasRequiredFields ? '包含所有必要字段' : '缺少必要字段');

                    // 测试个人信息
                    const profileResponse = await fetch(`${API_BASE}/students/me`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });
                    const profileData = await profileResponse.json();

                    addTestResult('studentDashboardTests', '个人信息访问',
                        profileData.success ? 'success' : 'error',
                        profileData.success ? `学生: ${profileData.data.name}` : profileData.message);

                } else {
                    addTestResult('studentDashboardTests', '仪表板访问', 'error', data.message);
                }
            } catch (error) {
                addTestResult('studentDashboardTests', '仪表板测试', 'error', error.message);
            }
        }

        // 学生讨论区测试
        async function testStudentDiscussion(token) {
            addTestResult('studentDiscussionTests', '开始讨论区测试...', 'info');

            try {
                // 获取讨论列表
                const response = await fetch(`${API_BASE}/learning/discussions`, {
                    headers: { Authorization: `Bearer ${token}` }
                });
                const data = await response.json();

                if (data.success) {
                    addTestResult('studentDiscussionTests', '讨论列表访问', 'success',
                        `找到${data.data.length}个讨论`);

                    // 测试创建讨论
                    const newDiscussion = {
                        title: `前端测试讨论-${Date.now()}`,
                        content: '这是前端测试创建的讨论',
                        type: 'general'
                    };

                    const createResponse = await fetch(`${API_BASE}/learning/discussions`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            Authorization: `Bearer ${token}`
                        },
                        body: JSON.stringify(newDiscussion)
                    });
                    const createData = await createResponse.json();

                    addTestResult('studentDiscussionTests', '创建讨论',
                        createData.success ? 'success' : 'error',
                        createData.success ? '成功创建讨论' : createData.message);

                    // 测试参与讨论
                    if (createData.success) {
                        const discussionId = createData.data._id;
                        const replyResponse = await fetch(`${API_BASE}/learning/discussions/${discussionId}/participate`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                Authorization: `Bearer ${token}`
                            },
                            body: JSON.stringify({ content: '这是一个测试回复' })
                        });
                        const replyData = await replyResponse.json();

                        addTestResult('studentDiscussionTests', '参与讨论',
                            replyData.success ? 'success' : 'error',
                            replyData.success ? '成功添加回复' : replyData.message);
                    }
                } else {
                    addTestResult('studentDiscussionTests', '讨论列表访问', 'error', data.message);
                }
            } catch (error) {
                addTestResult('studentDiscussionTests', '讨论区测试', 'error', error.message);
            }
        }

        // 学生权限限制测试
        async function testStudentRestrictions(token) {
            addTestResult('studentRestrictionTests', '开始权限限制测试...', 'info');

            const restrictedEndpoints = [
                { name: '学生列表', url: '/students' },
                { name: '员工列表', url: '/staff' },
                { name: '权限管理', url: '/permissions/permissions' },
                { name: '系统设置', url: '/settings' }
            ];

            for (const endpoint of restrictedEndpoints) {
                try {
                    const response = await fetch(`${API_BASE}${endpoint.url}`, {
                        headers: { Authorization: `Bearer ${token}` }
                    });

                    const shouldBeDenied = response.status === 403;
                    addTestResult('studentRestrictionTests', `${endpoint.name}访问限制`,
                        shouldBeDenied ? 'success' : 'error',
                        shouldBeDenied ? '正确被拒绝' : '应该被拒绝但没有');
                } catch (error) {
                    addTestResult('studentRestrictionTests', `${endpoint.name}访问限制`, 'success',
                        '正确被拒绝');
                }
            }
        }

        // 注册问题测试
        async function testRegistrationIssues() {
            addTestResult('studentRegistrationTests', '开始注册问题测试...', 'warning');
            addTestResult('staffRegistrationTests', '开始注册问题测试...', 'warning');

            // 测试学生注册
            const studentRegData = {
                studentId: `TESTSTU${Date.now()}`,
                name: '测试注册学生',
                email: `teststudent${Date.now()}@test.com`,
                password: 'test123456',
                confirmPassword: 'test123456',
                userType: 'student',
                grade: '大一',
                gender: 'male',
                phone: '13800138001',
                dateOfBirth: '2000-01-01'
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(studentRegData)
                });
                const data = await response.json();

                addTestResult('studentRegistrationTests', '学生注册功能 (已知问题)',
                    data.success ? 'success' : 'error',
                    data.success ? '注册成功' : `注册失败: ${data.message}`);

                if (!data.success) {
                    addTestResult('studentRegistrationTests', '⚠️ 确认已知问题', 'error',
                        '学生注册功能存在问题，无法正常注册');
                }
            } catch (error) {
                addTestResult('studentRegistrationTests', '学生注册功能 (已知问题)', 'error',
                    `注册错误: ${error.message}`);
            }

            // 测试员工注册
            const staffRegData = {
                staffId: `TESTSTAFF${Date.now()}`,
                name: '测试注册教师',
                email: `testteacher${Date.now()}@test.com`,
                password: 'test123456',
                confirmPassword: 'test123456',
                userType: 'staff',
                role: 'teacher',
                department: '计算机科学系',
                phone: '13900139001'
            };

            try {
                const response = await fetch(`${API_BASE}/auth/register`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(staffRegData)
                });
                const data = await response.json();

                addTestResult('staffRegistrationTests', '员工注册功能 (已知问题)',
                    data.success ? 'success' : 'error',
                    data.success ? '注册成功' : `注册失败: ${data.message}`);

                if (!data.success) {
                    addTestResult('staffRegistrationTests', '⚠️ 确认已知问题', 'error',
                        '员工注册功能存在问题，无法正常注册');
                }
            } catch (error) {
                addTestResult('staffRegistrationTests', '员工注册功能 (已知问题)', 'error',
                    `注册错误: ${error.message}`);
            }
        }

        // 角色分配问题测试
        async function testRoleAssignmentIssues() {
            addTestResult('studentRegistrationTests', '开始角色分配测试...', 'warning');
            addTestResult('staffRegistrationTests', '开始角色分配测试...', 'warning');

            // 测试不同角色的登录，验证角色分配
            const roleTests = [
                {
                    name: '校长角色验证',
                    credentials: { identifier: 'principal@school.edu', password: 'admin123', userType: 'staff' },
                    expectedRole: 'principal',
                    container: 'staffRegistrationTests'
                },
                {
                    name: '教师角色验证',
                    credentials: { identifier: 'wang@school.edu', password: 'admin123', userType: 'staff' },
                    expectedRole: 'head_teacher',
                    container: 'staffRegistrationTests'
                },
                {
                    name: '学生角色验证',
                    credentials: { identifier: '20230001', password: '20230001', userType: 'student' },
                    expectedRole: 'student',
                    container: 'studentRegistrationTests'
                }
            ];

            for (const test of roleTests) {
                try {
                    const response = await fetch(`${API_BASE}/auth/login`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(test.credentials)
                    });
                    const data = await response.json();

                    if (data.success) {
                        const user = data.data.user;
                        const roleCorrect = user.role === test.expectedRole;

                        addTestResult(test.container, test.name,
                            roleCorrect ? 'success' : 'error',
                            `期望角色: ${test.expectedRole}, 实际角色: ${user.role}`);

                        if (!roleCorrect) {
                            addTestResult(test.container, '⚠️ 角色分配问题', 'error',
                                '用户角色分配与预期不符');
                        }
                    } else {
                        addTestResult(test.container, test.name, 'error', data.message);
                    }
                } catch (error) {
                    addTestResult(test.container, test.name, 'error', error.message);
                }
            }
        }

        // 已知问题测试
        async function testKnownIssues() {
            addTestResult('principalSearchTests', '开始已知问题测试...', 'warning');

            // 如果校长已登录，测试搜索问题
            if (userTokens.principal) {
                await testStudentSearchIssues(userTokens.principal);
            } else {
                addTestResult('principalSearchTests', '需要先登录校长账户', 'warning');
            }

            // 测试注册问题
            await testRegistrationIssues();

            // 测试角色分配问题
            await testRoleAssignmentIssues();
        }

        // 运行所有角色测试
        async function runAllRoleTests() {
            clearAllResults();

            addTestResult('principalLoginTests', '开始全面测试...', 'info', new Date().toLocaleString());

            // 依次测试所有角色
            await testPrincipalPages();
            await new Promise(resolve => setTimeout(resolve, 1000)); // 短暂延迟

            await testTeacherPages();
            await new Promise(resolve => setTimeout(resolve, 1000));

            await testStudentPages();
            await new Promise(resolve => setTimeout(resolve, 1000));

            // 测试已知问题
            await testKnownIssues();

            // 显示总结
            const summary = `测试完成！总计: ${testStats.total}, 通过: ${testStats.passed}, 失败: ${testStats.failed}, 已知问题: ${testStats.knownIssues}`;
            addTestResult('principalLoginTests', summary, 'info');

            if (testStats.knownIssues > 0) {
                addTestResult('principalLoginTests', '⚠️ 发现已知问题', 'warning',
                    '部分功能存在已知问题，需要修复');
            }
        }

        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            addTestResult('principalLoginTests', '前端页面测试已准备就绪', 'success');
            addTestResult('teacherLoginTests', '等待开始测试...', 'info');
            addTestResult('studentLoginTests', '点击按钮开始测试', 'info');

            // 添加已知问题提醒
            addTestResult('principalSearchTests', '⚠️ 已知问题: 学生搜索功能', 'warning');
            addTestResult('studentRegistrationTests', '⚠️ 已知问题: 用户注册功能', 'warning');
            addTestResult('staffRegistrationTests', '⚠️ 已知问题: 角色分配逻辑', 'warning');
        });
    </script>
</body>
</html>
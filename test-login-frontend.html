<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•è·³è½¬æµ‹è¯•</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="mb-4">ç™»å½•è·³è½¬åŠŸèƒ½æµ‹è¯•</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>æµ‹è¯•ç™»å½•åŠŸèƒ½</h5>
            </div>
            <div class="card-body">
                <form id="testLoginForm">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">ç”¨æˆ·ç±»å‹</label>
                            <select class="form-select" id="userType" required>
                                <option value="staff">å‘˜å·¥</option>
                                <option value="student">å­¦ç”Ÿ</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">ç”¨æˆ·å</label>
                            <input type="text" class="form-control" id="identifier" value="principal@school.edu" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">å¯†ç </label>
                            <input type="password" class="form-control" id="password" value="admin123" required>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">æµ‹è¯•ç™»å½•</button>
                        <button type="button" class="btn btn-secondary" onclick="clearResults()">æ¸…é™¤ç»“æœ</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>æµ‹è¯•ç»“æœ</h5>
            </div>
            <div class="card-body">
                <div id="testResults"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API åŸºç¡€URL
        const API_BASE = '/api';
        
        // å·¥å…·å‡½æ•°
        const $ = (selector) => document.querySelector(selector);
        
        // HTTP è¯·æ±‚å°è£…
        const api = {
            async request(method, url, data = null) {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(`${API_BASE}${url}`, options);
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.message || 'è¯·æ±‚å¤±è´¥');
                    }

                    return result;
                } catch (error) {
                    console.error('APIè¯·æ±‚é”™è¯¯:', error);
                    throw error;
                }
            },

            post(url, data) { return this.request('POST', url, data); },
            get(url) { return this.request('GET', url); }
        };
        
        // æ·»åŠ æµ‹è¯•ç»“æœ
        function addTestResult(message, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = message;
            $('#testResults').appendChild(resultDiv);
        }
        
        // æ¸…é™¤ç»“æœ
        function clearResults() {
            $('#testResults').innerHTML = '';
        }
        
        // æµ‹è¯•ç™»å½•åŠŸèƒ½
        async function testLogin(formData) {
            addTestResult('ğŸ”„ å¼€å§‹æµ‹è¯•ç™»å½•...', 'info');
            
            try {
                // 1. æµ‹è¯•ç™»å½•API
                addTestResult('ğŸ“¡ è°ƒç”¨ç™»å½•API...', 'info');
                const result = await api.post('/auth/login', formData);
                
                if (result.success) {
                    addTestResult('âœ… ç™»å½•APIè°ƒç”¨æˆåŠŸ', 'success');
                    
                    // 2. æ£€æŸ¥è¿”å›çš„æ•°æ®ç»“æ„
                    const userData = result.data.user;
                    addTestResult(`ğŸ‘¤ ç”¨æˆ·ä¿¡æ¯: ${userData.name} (${userData.userType})`, 'success');
                    addTestResult(`ğŸ”‘ Token: ${result.data.accessToken.substring(0, 20)}...`, 'success');
                    
                    // 3. æµ‹è¯•ä»ªè¡¨æ¿APIï¼ˆå¦‚æœæ˜¯å­¦ç”Ÿï¼‰
                    if (userData.userType === 'student') {
                        addTestResult('ğŸ“Š æµ‹è¯•å­¦ç”Ÿä»ªè¡¨æ¿API...', 'info');
                        try {
                            const dashboardResponse = await fetch(`${API_BASE}/learning/dashboard`, {
                                headers: {
                                    'Authorization': `Bearer ${result.data.accessToken}`
                                }
                            });
                            const dashboardData = await dashboardResponse.json();
                            
                            if (dashboardData.success) {
                                addTestResult('âœ… å­¦ç”Ÿä»ªè¡¨æ¿APIæ­£å¸¸', 'success');
                                addTestResult(`ğŸ“ˆ å¾…å®Œæˆä½œä¸š: ${dashboardData.data.pendingAssignments.length}`, 'info');
                            } else {
                                addTestResult('âŒ å­¦ç”Ÿä»ªè¡¨æ¿APIå¤±è´¥: ' + dashboardData.message, 'error');
                            }
                        } catch (error) {
                            addTestResult('âŒ å­¦ç”Ÿä»ªè¡¨æ¿APIé”™è¯¯: ' + error.message, 'error');
                        }
                    }
                    
                    // 4. æ¨¡æ‹Ÿå‰ç«¯ç™»å½•åçš„å¤„ç†
                    addTestResult('ğŸ”„ æ¨¡æ‹Ÿå‰ç«¯ç™»å½•å¤„ç†...', 'info');
                    
                    // æ¨¡æ‹Ÿè®¾ç½®å…¨å±€å˜é‡
                    window.authToken = result.data.accessToken;
                    window.currentUser = result.data.user;
                    
                    // æ¨¡æ‹ŸlocalStorageå­˜å‚¨
                    localStorage.setItem('authToken', window.authToken);
                    localStorage.setItem('currentUser', JSON.stringify(window.currentUser));
                    
                    addTestResult('âœ… ç”¨æˆ·æ•°æ®å·²å­˜å‚¨åˆ°localStorage', 'success');
                    
                    // 5. æ£€æŸ¥ç”¨æˆ·ç±»å‹åˆ¤æ–­é€»è¾‘
                    if (window.currentUser.userType === 'student') {
                        addTestResult('âœ… ç”¨æˆ·ç±»å‹åˆ¤æ–­: å­¦ç”Ÿç”¨æˆ·ï¼Œåº”æ˜¾ç¤ºå­¦ç”Ÿä»ªè¡¨æ¿', 'success');
                    } else {
                        addTestResult('âœ… ç”¨æˆ·ç±»å‹åˆ¤æ–­: å‘˜å·¥ç”¨æˆ·ï¼Œåº”æ˜¾ç¤ºå‘˜å·¥ä»ªè¡¨æ¿', 'success');
                    }
                    
                    addTestResult('ğŸ‰ ç™»å½•æµ‹è¯•å®Œæˆï¼å‰ç«¯åº”è¯¥èƒ½æ­£å¸¸è·³è½¬åˆ°ä»ªè¡¨æ¿', 'success');
                    
                } else {
                    addTestResult('âŒ ç™»å½•å¤±è´¥: ' + result.message, 'error');
                }
                
            } catch (error) {
                addTestResult('âŒ ç™»å½•é”™è¯¯: ' + error.message, 'error');
            }
        }
        
        // è¡¨å•æäº¤å¤„ç†
        $('#testLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                identifier: $('#identifier').value,
                password: $('#password').value,
                userType: $('#userType').value
            };
            
            clearResults();
            await testLogin(formData);
        });
        
        // ç”¨æˆ·ç±»å‹åˆ‡æ¢æ—¶æ›´æ–°é»˜è®¤å€¼
        $('#userType').addEventListener('change', (e) => {
            if (e.target.value === 'student') {
                $('#identifier').value = '20230001';
                $('#password').value = '20230001';
            } else {
                $('#identifier').value = 'principal@school.edu';
                $('#password').value = 'admin123';
            }
        });
        
        // é¡µé¢åŠ è½½æ—¶çš„æç¤º
        document.addEventListener('DOMContentLoaded', () => {
            addTestResult('ğŸ“‹ ç™»å½•è·³è½¬æµ‹è¯•é¡µé¢å·²åŠ è½½', 'info');
            addTestResult('ğŸ’¡ è¯·é€‰æ‹©ç”¨æˆ·ç±»å‹å¹¶ç‚¹å‡»"æµ‹è¯•ç™»å½•"æŒ‰é’®', 'info');
            addTestResult('ğŸ”§ å¦‚æœæµ‹è¯•é€šè¿‡ä½†å®é™…é¡µé¢ä¸è·³è½¬ï¼Œè¯·æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°é”™è¯¯', 'info');
        });
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录跳转测试</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .test-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .test-result {
            margin: 10px 0;
            padding: 10px;
            border-radius: 5px;
        }
        .test-success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .test-error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .test-info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1 class="mb-4">登录跳转功能测试</h1>
        
        <div class="card mb-4">
            <div class="card-header">
                <h5>测试登录功能</h5>
            </div>
            <div class="card-body">
                <form id="testLoginForm">
                    <div class="row">
                        <div class="col-md-4">
                            <label class="form-label">用户类型</label>
                            <select class="form-select" id="userType" required>
                                <option value="staff">员工</option>
                                <option value="student">学生</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">用户名</label>
                            <input type="text" class="form-control" id="identifier" value="principal@school.edu" required>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">密码</label>
                            <input type="password" class="form-control" id="password" value="admin123" required>
                        </div>
                    </div>
                    <div class="mt-3">
                        <button type="submit" class="btn btn-primary">测试登录</button>
                        <button type="button" class="btn btn-secondary" onclick="clearResults()">清除结果</button>
                    </div>
                </form>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h5>测试结果</h5>
            </div>
            <div class="card-body">
                <div id="testResults"></div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // API 基础URL
        const API_BASE = '/api';
        
        // 工具函数
        const $ = (selector) => document.querySelector(selector);
        
        // HTTP 请求封装
        const api = {
            async request(method, url, data = null) {
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                }

                try {
                    const response = await fetch(`${API_BASE}${url}`, options);
                    const result = await response.json();

                    if (!response.ok) {
                        throw new Error(result.message || '请求失败');
                    }

                    return result;
                } catch (error) {
                    console.error('API请求错误:', error);
                    throw error;
                }
            },

            post(url, data) { return this.request('POST', url, data); },
            get(url) { return this.request('GET', url); }
        };
        
        // 添加测试结果
        function addTestResult(message, type = 'info') {
            const resultDiv = document.createElement('div');
            resultDiv.className = `test-result test-${type}`;
            resultDiv.innerHTML = message;
            $('#testResults').appendChild(resultDiv);
        }
        
        // 清除结果
        function clearResults() {
            $('#testResults').innerHTML = '';
        }
        
        // 测试登录功能
        async function testLogin(formData) {
            addTestResult('🔄 开始测试登录...', 'info');
            
            try {
                // 1. 测试登录API
                addTestResult('📡 调用登录API...', 'info');
                const result = await api.post('/auth/login', formData);
                
                if (result.success) {
                    addTestResult('✅ 登录API调用成功', 'success');
                    
                    // 2. 检查返回的数据结构
                    const userData = result.data.user;
                    addTestResult(`👤 用户信息: ${userData.name} (${userData.userType})`, 'success');
                    addTestResult(`🔑 Token: ${result.data.accessToken.substring(0, 20)}...`, 'success');
                    
                    // 3. 测试仪表板API（如果是学生）
                    if (userData.userType === 'student') {
                        addTestResult('📊 测试学生仪表板API...', 'info');
                        try {
                            const dashboardResponse = await fetch(`${API_BASE}/learning/dashboard`, {
                                headers: {
                                    'Authorization': `Bearer ${result.data.accessToken}`
                                }
                            });
                            const dashboardData = await dashboardResponse.json();
                            
                            if (dashboardData.success) {
                                addTestResult('✅ 学生仪表板API正常', 'success');
                                addTestResult(`📈 待完成作业: ${dashboardData.data.pendingAssignments.length}`, 'info');
                            } else {
                                addTestResult('❌ 学生仪表板API失败: ' + dashboardData.message, 'error');
                            }
                        } catch (error) {
                            addTestResult('❌ 学生仪表板API错误: ' + error.message, 'error');
                        }
                    }
                    
                    // 4. 模拟前端登录后的处理
                    addTestResult('🔄 模拟前端登录处理...', 'info');
                    
                    // 模拟设置全局变量
                    window.authToken = result.data.accessToken;
                    window.currentUser = result.data.user;
                    
                    // 模拟localStorage存储
                    localStorage.setItem('authToken', window.authToken);
                    localStorage.setItem('currentUser', JSON.stringify(window.currentUser));
                    
                    addTestResult('✅ 用户数据已存储到localStorage', 'success');
                    
                    // 5. 检查用户类型判断逻辑
                    if (window.currentUser.userType === 'student') {
                        addTestResult('✅ 用户类型判断: 学生用户，应显示学生仪表板', 'success');
                    } else {
                        addTestResult('✅ 用户类型判断: 员工用户，应显示员工仪表板', 'success');
                    }
                    
                    addTestResult('🎉 登录测试完成！前端应该能正常跳转到仪表板', 'success');
                    
                } else {
                    addTestResult('❌ 登录失败: ' + result.message, 'error');
                }
                
            } catch (error) {
                addTestResult('❌ 登录错误: ' + error.message, 'error');
            }
        }
        
        // 表单提交处理
        $('#testLoginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const formData = {
                identifier: $('#identifier').value,
                password: $('#password').value,
                userType: $('#userType').value
            };
            
            clearResults();
            await testLogin(formData);
        });
        
        // 用户类型切换时更新默认值
        $('#userType').addEventListener('change', (e) => {
            if (e.target.value === 'student') {
                $('#identifier').value = '20230001';
                $('#password').value = '20230001';
            } else {
                $('#identifier').value = 'principal@school.edu';
                $('#password').value = 'admin123';
            }
        });
        
        // 页面加载时的提示
        document.addEventListener('DOMContentLoaded', () => {
            addTestResult('📋 登录跳转测试页面已加载', 'info');
            addTestResult('💡 请选择用户类型并点击"测试登录"按钮', 'info');
            addTestResult('🔧 如果测试通过但实际页面不跳转，请检查浏览器控制台错误', 'info');
        });
    </script>
</body>
</html>

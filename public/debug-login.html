<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç™»å½•è°ƒè¯•é¡µé¢</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 15px; 
            margin: 10px 0; 
            max-height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
        }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-info { color: #007bff; }
        .log-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4>ğŸ” ç™»å½•è°ƒè¯•å·¥å…·</h4>
                    </div>
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="userType" class="form-label">ç”¨æˆ·ç±»å‹</label>
                                <select class="form-select" id="userType" required>
                                    <option value="staff">æ•™èŒå·¥</option>
                                    <option value="student">å­¦ç”Ÿ</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="identifier" class="form-label">ç”¨æˆ·å/å­¦å·</label>
                                <input type="text" class="form-control" id="identifier" value="principal@school.edu" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">å¯†ç </label>
                                <input type="password" class="form-control" id="password" value="admin123" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">ç™»å½•</button>
                        </form>
                        
                        <div class="mt-3">
                            <button class="btn btn-secondary btn-sm" onclick="testStudentLogin()">æµ‹è¯•å­¦ç”Ÿç™»å½•</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>è°ƒè¯•æ—¥å¿—</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugLog" class="debug-log"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // è°ƒè¯•æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // API åŸºç¡€URL
        const API_BASE = '/api';
        
        // HTTP è¯·æ±‚å°è£…ï¼ˆå¸¦è¯¦ç»†è°ƒè¯•ï¼‰
        const api = {
            async request(method, url, data = null) {
                log(`ğŸš€ å‘èµ·${method}è¯·æ±‚: ${API_BASE}${url}`, 'info');
                
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                    log(`ğŸ“¤ è¯·æ±‚æ•°æ®: ${JSON.stringify(data)}`, 'info');
                }

                try {
                    log(`ğŸŒ è¯·æ±‚URL: ${window.location.origin}${API_BASE}${url}`, 'info');
                    
                    const response = await fetch(`${API_BASE}${url}`, options);
                    
                    log(`ğŸ“¥ å“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 
                        response.ok ? 'success' : 'error');
                    
                    const result = await response.json();
                    
                    log(`ğŸ“‹ å“åº”æ•°æ®ç»“æ„: ${JSON.stringify(Object.keys(result))}`, 'info');
                    
                    if (!response.ok) {
                        log(`âŒ è¯·æ±‚å¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`, 'error');
                        throw new Error(result.message || 'è¯·æ±‚å¤±è´¥');
                    }

                    log(`âœ… è¯·æ±‚æˆåŠŸ`, 'success');
                    return result;
                } catch (error) {
                    log(`ğŸ’¥ ç½‘ç»œé”™è¯¯: ${error.message}`, 'error');
                    throw error;
                }
            },

            post(url, data) { return this.request('POST', url, data); }
        };

        // ç™»å½•å¤„ç†å‡½æ•°
        async function handleLogin(e) {
            e.preventDefault();
            
            log('ğŸ” å¼€å§‹ç™»å½•æµç¨‹', 'info');
            
            const formData = {
                identifier: document.getElementById('identifier').value,
                password: document.getElementById('password').value,
                userType: document.getElementById('userType').value
            };
            
            log(`ğŸ‘¤ ç™»å½•ä¿¡æ¯: ${formData.identifier} (${formData.userType})`, 'info');
            
            try {
                const result = await api.post('/auth/login', formData);
                
                log('ğŸ¯ æ£€æŸ¥å“åº”æ•°æ®ç»“æ„...', 'info');
                
                if (result.success && result.data) {
                    log('âœ… å“åº”æ ¼å¼æ­£ç¡®', 'success');
                    
                    if (result.data.accessToken && result.data.user) {
                        log('âœ… åŒ…å«å¿…è¦å­—æ®µ: accessToken, user', 'success');
                        
                        // æ¨¡æ‹Ÿå‰ç«¯å¤„ç†
                        const authToken = result.data.accessToken;
                        const currentUser = result.data.user;
                        
                        log(`ğŸ”‘ Token: ${authToken.substring(0, 20)}...`, 'success');
                        log(`ğŸ‘¤ ç”¨æˆ·: ${currentUser.name} (${currentUser.role})`, 'success');
                        
                        // å­˜å‚¨åˆ°localStorage
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        
                        log('ğŸ’¾ æ•°æ®å·²å­˜å‚¨åˆ°localStorage', 'success');
                        log('ğŸ‰ ç™»å½•æˆåŠŸï¼å‡†å¤‡è·³è½¬...', 'success');
                        
                        // 3ç§’åè·³è½¬åˆ°ä¸»é¡µé¢
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 3000);
                        
                    } else {
                        log('âŒ å“åº”ç¼ºå°‘å¿…è¦å­—æ®µ', 'error');
                    }
                } else {
                    log('âŒ å“åº”æ ¼å¼é”™è¯¯', 'error');
                }
                
            } catch (error) {
                log(`ğŸ’¥ ç™»å½•å¤±è´¥: ${error.message}`, 'error');
            }
        }

        // æµ‹è¯•å­¦ç”Ÿç™»å½•
        function testStudentLogin() {
            document.getElementById('userType').value = 'student';
            document.getElementById('identifier').value = '20230001';
            document.getElementById('password').value = '20230001';
            log('ğŸ”„ å·²åˆ‡æ¢åˆ°å­¦ç”Ÿç™»å½•æµ‹è¯•', 'info');
        }

        // ç»‘å®šäº‹ä»¶
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        
        // é¡µé¢åŠ è½½å®Œæˆ
        document.addEventListener('DOMContentLoaded', function() {
            log('ğŸš€ è°ƒè¯•é¡µé¢å·²åŠ è½½', 'success');
            log(`ğŸŒ å½“å‰URL: ${window.location.href}`, 'info');
            log('ğŸ“ è¯·å¡«å†™ç™»å½•ä¿¡æ¯å¹¶ç‚¹å‡»ç™»å½•æŒ‰é’®', 'info');
        });
    </script>
</body>
</html>

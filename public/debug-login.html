<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>登录调试页面</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-log { 
            background: #f8f9fa; 
            border: 1px solid #dee2e6; 
            border-radius: 5px; 
            padding: 15px; 
            margin: 10px 0; 
            max-height: 300px; 
            overflow-y: auto; 
            font-family: monospace; 
            font-size: 12px;
        }
        .log-success { color: #28a745; }
        .log-error { color: #dc3545; }
        .log-info { color: #007bff; }
        .log-warning { color: #ffc107; }
    </style>
</head>
<body>
    <div class="container mt-5">
        <div class="row justify-content-center">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h4>🔍 登录调试工具</h4>
                    </div>
                    <div class="card-body">
                        <form id="loginForm">
                            <div class="mb-3">
                                <label for="userType" class="form-label">用户类型</label>
                                <select class="form-select" id="userType" required>
                                    <option value="staff">教职工</option>
                                    <option value="student">学生</option>
                                </select>
                            </div>
                            <div class="mb-3">
                                <label for="identifier" class="form-label">用户名/学号</label>
                                <input type="text" class="form-control" id="identifier" value="principal@school.edu" required>
                            </div>
                            <div class="mb-3">
                                <label for="password" class="form-label">密码</label>
                                <input type="password" class="form-control" id="password" value="admin123" required>
                            </div>
                            <button type="submit" class="btn btn-primary w-100">登录</button>
                        </form>
                        
                        <div class="mt-3">
                            <button class="btn btn-secondary btn-sm" onclick="testStudentLogin()">测试学生登录</button>
                            <button class="btn btn-secondary btn-sm" onclick="clearLog()">清空日志</button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-3">
                    <div class="card-header">
                        <h5>调试日志</h5>
                    </div>
                    <div class="card-body">
                        <div id="debugLog" class="debug-log"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // 调试日志函数
        function log(message, type = 'info') {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logDiv.appendChild(logEntry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }

        // API 基础URL
        const API_BASE = '/api';
        
        // HTTP 请求封装（带详细调试）
        const api = {
            async request(method, url, data = null) {
                log(`🚀 发起${method}请求: ${API_BASE}${url}`, 'info');
                
                const options = {
                    method,
                    headers: {
                        'Content-Type': 'application/json',
                    }
                };

                if (data) {
                    options.body = JSON.stringify(data);
                    log(`📤 请求数据: ${JSON.stringify(data)}`, 'info');
                }

                try {
                    log(`🌐 请求URL: ${window.location.origin}${API_BASE}${url}`, 'info');
                    
                    const response = await fetch(`${API_BASE}${url}`, options);
                    
                    log(`📥 响应状态: ${response.status} ${response.statusText}`, 
                        response.ok ? 'success' : 'error');
                    
                    const result = await response.json();
                    
                    log(`📋 响应数据结构: ${JSON.stringify(Object.keys(result))}`, 'info');
                    
                    if (!response.ok) {
                        log(`❌ 请求失败: ${result.message || '未知错误'}`, 'error');
                        throw new Error(result.message || '请求失败');
                    }

                    log(`✅ 请求成功`, 'success');
                    return result;
                } catch (error) {
                    log(`💥 网络错误: ${error.message}`, 'error');
                    throw error;
                }
            },

            post(url, data) { return this.request('POST', url, data); }
        };

        // 登录处理函数
        async function handleLogin(e) {
            e.preventDefault();
            
            log('🔐 开始登录流程', 'info');
            
            const formData = {
                identifier: document.getElementById('identifier').value,
                password: document.getElementById('password').value,
                userType: document.getElementById('userType').value
            };
            
            log(`👤 登录信息: ${formData.identifier} (${formData.userType})`, 'info');
            
            try {
                const result = await api.post('/auth/login', formData);
                
                log('🎯 检查响应数据结构...', 'info');
                
                if (result.success && result.data) {
                    log('✅ 响应格式正确', 'success');
                    
                    if (result.data.accessToken && result.data.user) {
                        log('✅ 包含必要字段: accessToken, user', 'success');
                        
                        // 模拟前端处理
                        const authToken = result.data.accessToken;
                        const currentUser = result.data.user;
                        
                        log(`🔑 Token: ${authToken.substring(0, 20)}...`, 'success');
                        log(`👤 用户: ${currentUser.name} (${currentUser.role})`, 'success');
                        
                        // 存储到localStorage
                        localStorage.setItem('authToken', authToken);
                        localStorage.setItem('currentUser', JSON.stringify(currentUser));
                        
                        log('💾 数据已存储到localStorage', 'success');
                        log('🎉 登录成功！准备跳转...', 'success');
                        
                        // 3秒后跳转到主页面
                        setTimeout(() => {
                            window.location.href = '/';
                        }, 3000);
                        
                    } else {
                        log('❌ 响应缺少必要字段', 'error');
                    }
                } else {
                    log('❌ 响应格式错误', 'error');
                }
                
            } catch (error) {
                log(`💥 登录失败: ${error.message}`, 'error');
            }
        }

        // 测试学生登录
        function testStudentLogin() {
            document.getElementById('userType').value = 'student';
            document.getElementById('identifier').value = '20230001';
            document.getElementById('password').value = '20230001';
            log('🔄 已切换到学生登录测试', 'info');
        }

        // 绑定事件
        document.getElementById('loginForm').addEventListener('submit', handleLogin);
        
        // 页面加载完成
        document.addEventListener('DOMContentLoaded', function() {
            log('🚀 调试页面已加载', 'success');
            log(`🌐 当前URL: ${window.location.href}`, 'info');
            log('📝 请填写登录信息并点击登录按钮', 'info');
        });
    </script>
</body>
</html>
